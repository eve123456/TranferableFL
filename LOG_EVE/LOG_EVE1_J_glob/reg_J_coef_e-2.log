nohup: ignoring input
working!
check why cannot sync
Using device: cuda:0
>>> Arguments:
	             algo : fedavgtl
	            alpha : 13.2316427
	       batch_size : 64
	clients_per_round : 100
	             clip : False
	          dataset : mnist_all_data_1_equal_niid
	           device : cuda:0
	              dis : 
	   early_stopping : 10
	       eval_every : 5
	    ft_batch_size : 128
	       ft_dataset : mnist-m
	        ft_epochs : 200
	            ft_lr : 0.001
	            ft_wd : 0.0001
	              gpu : True
	      input_shape : (1, 28, 28)
	           last_k : 1
	               lr : 0.01
	            model : lenet
	           n_init : 1
	        noaverage : False
	             noft : False
	          noprint : False
	        num_class : 10
	        num_epoch : 1
	        num_round : 200
	           opt_lr : False
	            reg_J : False
	       reg_J_coef : 0.0
	   reg_J_ind_coef : 0.01
	  reg_J_norm_coef : 0.0
	           repeat : 1
	     repeat_epoch : 10
	             seed : 0
	               wd : 0.0
>>> Read data from:
     ./data/mnist/data/all_data_1.pkl
>>> The estimate of constant alpha is 13.2316427.
>>> Read data from:
     ./data/mnist/data/train/all_data_1_equal_niid.pkl
     ./data/mnist/data/test/all_data_1_equal_niid.pkl

************************************************************************************************************************

uid: 20230926213734
FL pretrained model will be saved at ./models/lenet_mnist_20230926213734.pt
>>> Use gpu on device cuda:0
>>> Model statistic per layer
LeNet_MNIST(
  286.12 KMac, 100.000% MACs, 
  (conv1): Conv2d(89.856 KMac, 31.405% MACs, 1, 6, kernel_size=(5, 5), stride=(1, 1))
  (conv2): Conv2d(154.624 KMac, 54.042% MACs, 6, 16, kernel_size=(5, 5), stride=(1, 1))
  (fc1): Linear(30.72 KMac, 10.737% MACs, in_features=256, out_features=120, bias=True)
  (fc2): Linear(10.08 KMac, 3.523% MACs, in_features=120, out_features=84, bias=True)
  (fc3): Linear(840.0 Mac, 0.294% MACs, in_features=84, out_features=10, bias=True)
)
>>> Activate a worker for training
>>> Initialize 100 clients in total
>>> Weigh updates by simple average
>>> Select 100 clients per round 


>>> Round:    0 / Acc: 10.522% / Loss: 2.3080 /Time: 4.15s
======================================================================================================

= Test = round: 0 / acc: 11.160% / loss: 2.3058 / Time: 0.82s
======================================================================================================


>>> Round:    5 / Acc: 12.946% / Loss: 2.2970 /Time: 4.19s
======================================================================================================

= Test = round: 5 / acc: 13.720% / loss: 2.2945 / Time: 0.82s
======================================================================================================


>>> Round:   10 / Acc: 18.649% / Loss: 2.2739 /Time: 4.23s
======================================================================================================

= Test = round: 10 / acc: 20.170% / loss: 2.2706 / Time: 0.83s
======================================================================================================


>>> Round:   15 / Acc: 32.869% / Loss: 2.1830 /Time: 4.19s
======================================================================================================

= Test = round: 15 / acc: 33.780% / loss: 2.1794 / Time: 0.80s
======================================================================================================


>>> Round:   20 / Acc: 57.079% / Loss: 1.9772 /Time: 4.13s
======================================================================================================

= Test = round: 20 / acc: 57.890% / loss: 1.9665 / Time: 0.80s
======================================================================================================


>>> Round:   25 / Acc: 60.779% / Loss: 1.7282 /Time: 5.74s
======================================================================================================

= Test = round: 25 / acc: 62.530% / loss: 1.7065 / Time: 1.10s
======================================================================================================


>>> Round:   30 / Acc: 63.196% / Loss: 1.5053 /Time: 4.32s
======================================================================================================

= Test = round: 30 / acc: 64.930% / loss: 1.4768 / Time: 0.89s
======================================================================================================


>>> Round:   35 / Acc: 67.061% / Loss: 1.3102 /Time: 4.27s
======================================================================================================

= Test = round: 35 / acc: 68.430% / loss: 1.2793 / Time: 0.82s
======================================================================================================


>>> Round:   40 / Acc: 71.349% / Loss: 1.1412 /Time: 4.13s
======================================================================================================

= Test = round: 40 / acc: 72.300% / loss: 1.1099 / Time: 0.80s
======================================================================================================


>>> Round:   45 / Acc: 75.461% / Loss: 0.9967 /Time: 4.37s
======================================================================================================

= Test = round: 45 / acc: 76.500% / loss: 0.9660 / Time: 0.95s
======================================================================================================


>>> Round:   50 / Acc: 77.865% / Loss: 0.8770 /Time: 4.22s
======================================================================================================

= Test = round: 50 / acc: 79.060% / loss: 0.8454 / Time: 0.82s
======================================================================================================


>>> Round:   55 / Acc: 79.839% / Loss: 0.7907 /Time: 4.42s
======================================================================================================

= Test = round: 55 / acc: 80.970% / loss: 0.7591 / Time: 0.81s
======================================================================================================


>>> Round:   60 / Acc: 81.225% / Loss: 0.7163 /Time: 4.21s
======================================================================================================

= Test = round: 60 / acc: 82.430% / loss: 0.6846 / Time: 0.79s
======================================================================================================


>>> Round:   65 / Acc: 82.649% / Loss: 0.6530 /Time: 4.42s
======================================================================================================

= Test = round: 65 / acc: 84.090% / loss: 0.6214 / Time: 0.86s
======================================================================================================


>>> Round:   70 / Acc: 83.625% / Loss: 0.6075 /Time: 4.44s
======================================================================================================

= Test = round: 70 / acc: 85.130% / loss: 0.5757 / Time: 0.84s
======================================================================================================


>>> Round:   75 / Acc: 84.648% / Loss: 0.5575 /Time: 4.45s
======================================================================================================

= Test = round: 75 / acc: 85.930% / loss: 0.5266 / Time: 0.85s
======================================================================================================


>>> Round:   80 / Acc: 85.576% / Loss: 0.5204 /Time: 4.48s
======================================================================================================

= Test = round: 80 / acc: 86.810% / loss: 0.4896 / Time: 0.86s
======================================================================================================


>>> Round:   85 / Acc: 86.249% / Loss: 0.4866 /Time: 4.26s
======================================================================================================

= Test = round: 85 / acc: 87.350% / loss: 0.4575 / Time: 0.83s
======================================================================================================


>>> Round:   90 / Acc: 86.899% / Loss: 0.4631 /Time: 4.15s
======================================================================================================

= Test = round: 90 / acc: 88.200% / loss: 0.4341 / Time: 0.81s
======================================================================================================


>>> Round:   95 / Acc: 87.533% / Loss: 0.4423 /Time: 4.32s
======================================================================================================

= Test = round: 95 / acc: 88.780% / loss: 0.4140 / Time: 0.83s
======================================================================================================


>>> Round:  100 / Acc: 88.087% / Loss: 0.4219 /Time: 4.28s
======================================================================================================

= Test = round: 100 / acc: 89.290% / loss: 0.3940 / Time: 0.81s
======================================================================================================


>>> Round:  105 / Acc: 88.611% / Loss: 0.4003 /Time: 4.26s
======================================================================================================

= Test = round: 105 / acc: 89.870% / loss: 0.3733 / Time: 0.80s
======================================================================================================


>>> Round:  110 / Acc: 89.111% / Loss: 0.3825 /Time: 4.33s
======================================================================================================

= Test = round: 110 / acc: 90.340% / loss: 0.3560 / Time: 0.80s
======================================================================================================


>>> Round:  115 / Acc: 89.491% / Loss: 0.3725 /Time: 4.61s
======================================================================================================

= Test = round: 115 / acc: 90.530% / loss: 0.3466 / Time: 0.90s
======================================================================================================


>>> Round:  120 / Acc: 89.889% / Loss: 0.3568 /Time: 4.34s
======================================================================================================

= Test = round: 120 / acc: 91.030% / loss: 0.3312 / Time: 0.81s
======================================================================================================


>>> Round:  125 / Acc: 90.297% / Loss: 0.3446 /Time: 4.57s
======================================================================================================

= Test = round: 125 / acc: 91.390% / loss: 0.3202 / Time: 0.78s
======================================================================================================


>>> Round:  130 / Acc: 90.585% / Loss: 0.3318 /Time: 4.31s
======================================================================================================

= Test = round: 130 / acc: 91.620% / loss: 0.3083 / Time: 0.78s
======================================================================================================


>>> Round:  135 / Acc: 90.873% / Loss: 0.3226 /Time: 4.31s
======================================================================================================

= Test = round: 135 / acc: 91.870% / loss: 0.2990 / Time: 0.79s
======================================================================================================


>>> Round:  140 / Acc: 91.221% / Loss: 0.3131 /Time: 4.15s
======================================================================================================

= Test = round: 140 / acc: 92.140% / loss: 0.2906 / Time: 0.78s
======================================================================================================


>>> Round:  145 / Acc: 91.441% / Loss: 0.3021 /Time: 4.20s
======================================================================================================

= Test = round: 145 / acc: 92.360% / loss: 0.2800 / Time: 0.79s
======================================================================================================


>>> Round:  150 / Acc: 91.638% / Loss: 0.2950 /Time: 4.19s
======================================================================================================

= Test = round: 150 / acc: 92.450% / loss: 0.2737 / Time: 0.80s
======================================================================================================


>>> Round:  155 / Acc: 91.871% / Loss: 0.2833 /Time: 4.34s
======================================================================================================

= Test = round: 155 / acc: 92.610% / loss: 0.2621 / Time: 0.80s
======================================================================================================


>>> Round:  160 / Acc: 92.077% / Loss: 0.2761 /Time: 4.21s
======================================================================================================

= Test = round: 160 / acc: 92.840% / loss: 0.2554 / Time: 0.82s
======================================================================================================


>>> Round:  165 / Acc: 92.255% / Loss: 0.2685 /Time: 4.19s
======================================================================================================

= Test = round: 165 / acc: 92.970% / loss: 0.2484 / Time: 0.84s
======================================================================================================


>>> Round:  170 / Acc: 92.406% / Loss: 0.2628 /Time: 4.13s
======================================================================================================

= Test = round: 170 / acc: 93.130% / loss: 0.2427 / Time: 0.83s
======================================================================================================


>>> Round:  175 / Acc: 92.550% / Loss: 0.2573 /Time: 4.11s
======================================================================================================

= Test = round: 175 / acc: 93.380% / loss: 0.2378 / Time: 0.78s
======================================================================================================


>>> Round:  180 / Acc: 92.720% / Loss: 0.2520 /Time: 4.15s
======================================================================================================

= Test = round: 180 / acc: 93.490% / loss: 0.2325 / Time: 0.79s
======================================================================================================


>>> Round:  185 / Acc: 92.862% / Loss: 0.2471 /Time: 4.18s
======================================================================================================

= Test = round: 185 / acc: 93.580% / loss: 0.2275 / Time: 0.79s
======================================================================================================


>>> Round:  190 / Acc: 93.000% / Loss: 0.2425 /Time: 4.25s
======================================================================================================

= Test = round: 190 / acc: 93.690% / loss: 0.2231 / Time: 0.82s
======================================================================================================


>>> Round:  195 / Acc: 93.170% / Loss: 0.2364 /Time: 4.27s
======================================================================================================

= Test = round: 195 / acc: 93.790% / loss: 0.2181 / Time: 0.79s
======================================================================================================


>>> Round:  200 / Acc: 93.220% / Loss: 0.2313 /Time: 4.61s
======================================================================================================

= Test = round: 200 / acc: 93.820% / loss: 0.2135 / Time: 0.90s
======================================================================================================

>>> Training model_ft
Epoch: 001, Train_loss: 1.0615, Train_acc: 0.6797, Test_loss: 1.0451, Test_acc: 0.6827
Epoch: 006, Train_loss: 0.8615, Train_acc: 0.7338, Test_loss: 0.8649, Test_acc: 0.7343
Epoch: 011, Train_loss: 0.7978, Train_acc: 0.7492, Test_loss: 0.8188, Test_acc: 0.7430
Epoch: 016, Train_loss: 0.7665, Train_acc: 0.7567, Test_loss: 0.8040, Test_acc: 0.7446
Epoch: 021, Train_loss: 0.7281, Train_acc: 0.7658, Test_loss: 0.7765, Test_acc: 0.7530
Epoch: 026, Train_loss: 0.7111, Train_acc: 0.7697, Test_loss: 0.7746, Test_acc: 0.7528
Epoch: 031, Train_loss: 0.6951, Train_acc: 0.7738, Test_loss: 0.7680, Test_acc: 0.7531
Epoch: 036, Train_loss: 0.6900, Train_acc: 0.7741, Test_loss: 0.7733, Test_acc: 0.7511
Epoch: 041, Train_loss: 0.6652, Train_acc: 0.7841, Test_loss: 0.7569, Test_acc: 0.7602
Epoch: 046, Train_loss: 0.6624, Train_acc: 0.7845, Test_loss: 0.7621, Test_acc: 0.7560
Epoch: 051, Train_loss: 0.6550, Train_acc: 0.7857, Test_loss: 0.7617, Test_acc: 0.7567
Epoch: 056, Train_loss: 0.6483, Train_acc: 0.7875, Test_loss: 0.7621, Test_acc: 0.7566
Epoch: 061, Train_loss: 0.6437, Train_acc: 0.7894, Test_loss: 0.7669, Test_acc: 0.7562
Epoch: 066, Train_loss: 0.6379, Train_acc: 0.7923, Test_loss: 0.7672, Test_acc: 0.7560
Epoch: 071, Train_loss: 0.6273, Train_acc: 0.7947, Test_loss: 0.7635, Test_acc: 0.7586
Epoch: 076, Train_loss: 0.6332, Train_acc: 0.7931, Test_loss: 0.7790, Test_acc: 0.7547
Epoch: 081, Train_loss: 0.6236, Train_acc: 0.7949, Test_loss: 0.7625, Test_acc: 0.7598
Epoch: 086, Train_loss: 0.6186, Train_acc: 0.7976, Test_loss: 0.7619, Test_acc: 0.7576
Epoch: 091, Train_loss: 0.6164, Train_acc: 0.7981, Test_loss: 0.7688, Test_acc: 0.7584
Epoch: 096, Train_loss: 0.6089, Train_acc: 0.7998, Test_loss: 0.7637, Test_acc: 0.7570
Epoch: 101, Train_loss: 0.6142, Train_acc: 0.7984, Test_loss: 0.7721, Test_acc: 0.7582
Epoch: 106, Train_loss: 0.6078, Train_acc: 0.8007, Test_loss: 0.7708, Test_acc: 0.7607
Epoch: 111, Train_loss: 0.6131, Train_acc: 0.7988, Test_loss: 0.7794, Test_acc: 0.7538
Epoch: 116, Train_loss: 0.6004, Train_acc: 0.8034, Test_loss: 0.7659, Test_acc: 0.7566
Epoch: 121, Train_loss: 0.6038, Train_acc: 0.8012, Test_loss: 0.7778, Test_acc: 0.7566
Epoch: 126, Train_loss: 0.6060, Train_acc: 0.7995, Test_loss: 0.7829, Test_acc: 0.7585
Epoch: 131, Train_loss: 0.6031, Train_acc: 0.8010, Test_loss: 0.7804, Test_acc: 0.7565
Epoch: 136, Train_loss: 0.5905, Train_acc: 0.8070, Test_loss: 0.7683, Test_acc: 0.7582
Epoch: 141, Train_loss: 0.5988, Train_acc: 0.8033, Test_loss: 0.7790, Test_acc: 0.7564
Epoch: 146, Train_loss: 0.5883, Train_acc: 0.8072, Test_loss: 0.7729, Test_acc: 0.7622
Epoch: 151, Train_loss: 0.5881, Train_acc: 0.8055, Test_loss: 0.7719, Test_acc: 0.7596
Epoch: 156, Train_loss: 0.5921, Train_acc: 0.8047, Test_loss: 0.7750, Test_acc: 0.7590
Fine-tuning early stopped. Model saved at ./models/ft_checkpoints/20230926213734_model_ft.pt.
Model saved at ./models/ft_checkpoints/20230926213734_model_ft.pt.
>>> Fine-tuning done!
>>> Evaluating model_source_only
model_ft: [0.5829038909335404, 0.8093252656734632, 0.7717141682089017, 0.7592489723364071]
model_source_only: [1.8050592875202232, 0.46905984644328064, 1.810400007777897, 0.47083657371403176]
fl_test_acc_mean 0.9383
model_source_only_test_acc_mean 0.47083657371403176
model_ft_test_acc_mean 0.7592489723364071
