nohup: ignoring input
working!
Using device: cuda:0
>>> Arguments:
	             algo : fedavgtl
	            alpha : 13.2316427
	       batch_size : 600
	clients_per_round : 100
	             clip : True
	          dataset : mnist_all_data_1_equal_niid
	           device : cuda:0
	              dis : 
	   early_stopping : 10
	       eval_every : 5
	    ft_batch_size : 128
	       ft_dataset : mnist-m
	        ft_epochs : 200
	            ft_lr : 0.001
	            ft_wd : 0.01
	              gpu : True
	      input_shape : (1, 28, 28)
	           last_k : 1
	               lr : 0.001
	            model : lenet
	           n_init : 1
	        noaverage : False
	             noft : False
	          noprint : False
	        num_class : 10
	        num_epoch : 1
	        num_round : 200
	           opt_lr : False
	            reg_J : False
	       reg_J_coef : 0.0
	   reg_J_ind_coef : 0.0
	  reg_J_norm_coef : 0.0
	           repeat : 1
	     repeat_epoch : 10
	             seed : 0
	               wd : 0.0
>>> Read data from:
     ./data/mnist/data/all_data_1.pkl
>>> The estimate of constant alpha is 13.2316427.
>>> Read data from:
     ./data/mnist/data/train/all_data_1_equal_niid.pkl
     ./data/mnist/data/test/all_data_1_equal_niid.pkl

************************************************************************************************************************

uid: 20230921212212
FL pretrained model will be saved at ./models/lenet_mnist_20230921212212.pt
>>> Use gpu on device cuda:0
>>> Model statistic per layer
LeNet_MNIST(
  286.12 KMac, 100.000% MACs, 
  (conv1): Conv2d(89.856 KMac, 31.405% MACs, 1, 6, kernel_size=(5, 5), stride=(1, 1))
  (conv2): Conv2d(154.624 KMac, 54.042% MACs, 6, 16, kernel_size=(5, 5), stride=(1, 1))
  (fc1): Linear(30.72 KMac, 10.737% MACs, in_features=256, out_features=120, bias=True)
  (fc2): Linear(10.08 KMac, 3.523% MACs, in_features=120, out_features=84, bias=True)
  (fc3): Linear(840.0 Mac, 0.294% MACs, in_features=84, out_features=10, bias=True)
)
>>> Activate a worker for training
>>> Initialize 100 clients in total
>>> Weigh updates by simple average
>>> Select 100 clients per round 


>>> Round:    0 / Acc: 8.469% / Loss: 2.3034 / Grad Norm: 0.1156 / Grad Diff: 0.7151 / Time: 8.45s
======================================================================================================

= Test = round: 0 / acc: 8.580% / loss: 2.3041 / Time: 0.87s
======================================================================================================

round 0 local learning rate = 0.001
round 1 local learning rate = 0.001
round 2 local learning rate = 0.001
round 3 local learning rate = 0.001
round 4 local learning rate = 0.001

>>> Round:    5 / Acc: 8.408% / Loss: 2.3027 / Grad Norm: 0.1161 / Grad Diff: 0.7175 / Time: 8.52s
======================================================================================================

= Test = round: 5 / acc: 8.470% / loss: 2.3034 / Time: 0.91s
======================================================================================================

round 5 local learning rate = 0.001
round 6 local learning rate = 0.001
round 7 local learning rate = 0.001
round 8 local learning rate = 0.001
round 9 local learning rate = 0.001

>>> Round:   10 / Acc: 8.365% / Loss: 2.3021 / Grad Norm: 0.1168 / Grad Diff: 0.7204 / Time: 8.26s
======================================================================================================

= Test = round: 10 / acc: 8.450% / loss: 2.3027 / Time: 0.96s
======================================================================================================

round 10 local learning rate = 0.001
round 11 local learning rate = 0.001
round 12 local learning rate = 0.001
round 13 local learning rate = 0.001
round 14 local learning rate = 0.001

>>> Round:   15 / Acc: 8.410% / Loss: 2.3014 / Grad Norm: 0.1176 / Grad Diff: 0.7238 / Time: 8.67s
======================================================================================================

= Test = round: 15 / acc: 8.390% / loss: 2.3020 / Time: 0.91s
======================================================================================================

round 15 local learning rate = 0.001
round 16 local learning rate = 0.001
round 17 local learning rate = 0.001
round 18 local learning rate = 0.001
round 19 local learning rate = 0.001

>>> Round:   20 / Acc: 8.557% / Loss: 2.3007 / Grad Norm: 0.1185 / Grad Diff: 0.7278 / Time: 8.53s
======================================================================================================

= Test = round: 20 / acc: 8.430% / loss: 2.3013 / Time: 0.96s
======================================================================================================

round 20 local learning rate = 0.001
round 21 local learning rate = 0.001
round 22 local learning rate = 0.001
round 23 local learning rate = 0.001
round 24 local learning rate = 0.001

>>> Round:   25 / Acc: 8.828% / Loss: 2.3000 / Grad Norm: 0.1194 / Grad Diff: 0.7324 / Time: 8.32s
======================================================================================================

= Test = round: 25 / acc: 8.720% / loss: 2.3006 / Time: 0.87s
======================================================================================================

round 25 local learning rate = 0.001
round 26 local learning rate = 0.001
round 27 local learning rate = 0.001
round 28 local learning rate = 0.001
round 29 local learning rate = 0.001

>>> Round:   30 / Acc: 9.255% / Loss: 2.2992 / Grad Norm: 0.1205 / Grad Diff: 0.7378 / Time: 8.43s
======================================================================================================

= Test = round: 30 / acc: 9.080% / loss: 2.2999 / Time: 0.92s
======================================================================================================

round 30 local learning rate = 0.001
round 31 local learning rate = 0.001
round 32 local learning rate = 0.001
round 33 local learning rate = 0.001
round 34 local learning rate = 0.001

>>> Round:   35 / Acc: 9.696% / Loss: 2.2985 / Grad Norm: 0.1218 / Grad Diff: 0.7438 / Time: 8.51s
======================================================================================================

= Test = round: 35 / acc: 9.580% / loss: 2.2991 / Time: 0.89s
======================================================================================================

round 35 local learning rate = 0.001
round 36 local learning rate = 0.001
round 37 local learning rate = 0.001
round 38 local learning rate = 0.001
round 39 local learning rate = 0.001

>>> Round:   40 / Acc: 10.232% / Loss: 2.2977 / Grad Norm: 0.1232 / Grad Diff: 0.7504 / Time: 8.96s
======================================================================================================

= Test = round: 40 / acc: 10.050% / loss: 2.2983 / Time: 0.89s
======================================================================================================

round 40 local learning rate = 0.001
round 41 local learning rate = 0.001
round 42 local learning rate = 0.001
round 43 local learning rate = 0.001
round 44 local learning rate = 0.001

>>> Round:   45 / Acc: 10.769% / Loss: 2.2969 / Grad Norm: 0.1248 / Grad Diff: 0.7578 / Time: 9.85s
======================================================================================================

= Test = round: 45 / acc: 10.660% / loss: 2.2975 / Time: 0.94s
======================================================================================================

round 45 local learning rate = 0.001
round 46 local learning rate = 0.001
round 47 local learning rate = 0.001
round 48 local learning rate = 0.001
round 49 local learning rate = 0.001

>>> Round:   50 / Acc: 11.249% / Loss: 2.2961 / Grad Norm: 0.1264 / Grad Diff: 0.7658 / Time: 9.55s
======================================================================================================

= Test = round: 50 / acc: 11.180% / loss: 2.2967 / Time: 0.96s
======================================================================================================

round 50 local learning rate = 0.001
round 51 local learning rate = 0.001
round 52 local learning rate = 0.001
round 53 local learning rate = 0.001
round 54 local learning rate = 0.001

>>> Round:   55 / Acc: 11.742% / Loss: 2.2953 / Grad Norm: 0.1282 / Grad Diff: 0.7746 / Time: 8.64s
======================================================================================================

= Test = round: 55 / acc: 11.480% / loss: 2.2959 / Time: 0.85s
======================================================================================================

round 55 local learning rate = 0.001
round 56 local learning rate = 0.001
round 57 local learning rate = 0.001
round 58 local learning rate = 0.001
round 59 local learning rate = 0.001

>>> Round:   60 / Acc: 12.103% / Loss: 2.2945 / Grad Norm: 0.1301 / Grad Diff: 0.7843 / Time: 8.59s
======================================================================================================

= Test = round: 60 / acc: 12.020% / loss: 2.2950 / Time: 0.78s
======================================================================================================

round 60 local learning rate = 0.001
round 61 local learning rate = 0.001
round 62 local learning rate = 0.001
round 63 local learning rate = 0.001
round 64 local learning rate = 0.001

>>> Round:   65 / Acc: 12.459% / Loss: 2.2936 / Grad Norm: 0.1320 / Grad Diff: 0.7949 / Time: 7.67s
======================================================================================================

= Test = round: 65 / acc: 12.390% / loss: 2.2942 / Time: 0.75s
======================================================================================================

round 65 local learning rate = 0.001
round 66 local learning rate = 0.001
round 67 local learning rate = 0.001
round 68 local learning rate = 0.001
round 69 local learning rate = 0.001

>>> Round:   70 / Acc: 12.740% / Loss: 2.2927 / Grad Norm: 0.1340 / Grad Diff: 0.8063 / Time: 7.45s
======================================================================================================

= Test = round: 70 / acc: 12.600% / loss: 2.2933 / Time: 0.77s
======================================================================================================

round 70 local learning rate = 0.001
round 71 local learning rate = 0.001
round 72 local learning rate = 0.001
round 73 local learning rate = 0.001
round 74 local learning rate = 0.001

>>> Round:   75 / Acc: 12.902% / Loss: 2.2917 / Grad Norm: 0.1362 / Grad Diff: 0.8189 / Time: 7.59s
======================================================================================================

= Test = round: 75 / acc: 12.800% / loss: 2.2923 / Time: 0.76s
======================================================================================================

round 75 local learning rate = 0.001
round 76 local learning rate = 0.001
round 77 local learning rate = 0.001
round 78 local learning rate = 0.001
round 79 local learning rate = 0.001

>>> Round:   80 / Acc: 13.039% / Loss: 2.2908 / Grad Norm: 0.1385 / Grad Diff: 0.8327 / Time: 7.62s
======================================================================================================

= Test = round: 80 / acc: 12.800% / loss: 2.2913 / Time: 0.77s
======================================================================================================

round 80 local learning rate = 0.001
round 81 local learning rate = 0.001
round 82 local learning rate = 0.001
round 83 local learning rate = 0.001
round 84 local learning rate = 0.001

>>> Round:   85 / Acc: 13.089% / Loss: 2.2898 / Grad Norm: 0.1410 / Grad Diff: 0.8475 / Time: 7.63s
======================================================================================================

= Test = round: 85 / acc: 12.820% / loss: 2.2903 / Time: 0.77s
======================================================================================================

round 85 local learning rate = 0.001
round 86 local learning rate = 0.001
round 87 local learning rate = 0.001
round 88 local learning rate = 0.001
round 89 local learning rate = 0.001

>>> Round:   90 / Acc: 13.138% / Loss: 2.2887 / Grad Norm: 0.1435 / Grad Diff: 0.8635 / Time: 8.38s
======================================================================================================

= Test = round: 90 / acc: 12.860% / loss: 2.2893 / Time: 0.77s
======================================================================================================

round 90 local learning rate = 0.001
round 91 local learning rate = 0.001
round 92 local learning rate = 0.001
round 93 local learning rate = 0.001
round 94 local learning rate = 0.001

>>> Round:   95 / Acc: 13.210% / Loss: 2.2876 / Grad Norm: 0.1463 / Grad Diff: 0.8811 / Time: 7.62s
======================================================================================================

= Test = round: 95 / acc: 12.870% / loss: 2.2882 / Time: 0.76s
======================================================================================================

round 95 local learning rate = 0.001
round 96 local learning rate = 0.001
round 97 local learning rate = 0.001
round 98 local learning rate = 0.001
round 99 local learning rate = 0.001

>>> Round:  100 / Acc: 13.225% / Loss: 2.2865 / Grad Norm: 0.1494 / Grad Diff: 0.9002 / Time: 7.35s
======================================================================================================

= Test = round: 100 / acc: 12.900% / loss: 2.2871 / Time: 0.74s
======================================================================================================

round 100 local learning rate = 0.001
round 101 local learning rate = 0.001
round 102 local learning rate = 0.001
round 103 local learning rate = 0.001
round 104 local learning rate = 0.001

>>> Round:  105 / Acc: 13.162% / Loss: 2.2853 / Grad Norm: 0.1527 / Grad Diff: 0.9209 / Time: 7.50s
======================================================================================================

= Test = round: 105 / acc: 12.920% / loss: 2.2859 / Time: 0.74s
======================================================================================================

round 105 local learning rate = 0.001
round 106 local learning rate = 0.001
round 107 local learning rate = 0.001
round 108 local learning rate = 0.001
round 109 local learning rate = 0.001

>>> Round:  110 / Acc: 13.096% / Loss: 2.2841 / Grad Norm: 0.1561 / Grad Diff: 0.9435 / Time: 7.52s
======================================================================================================

= Test = round: 110 / acc: 12.890% / loss: 2.2847 / Time: 0.75s
======================================================================================================

round 110 local learning rate = 0.001
round 111 local learning rate = 0.001
round 112 local learning rate = 0.001
round 113 local learning rate = 0.001
round 114 local learning rate = 0.001

>>> Round:  115 / Acc: 13.068% / Loss: 2.2828 / Grad Norm: 0.1599 / Grad Diff: 0.9682 / Time: 9.94s
======================================================================================================

= Test = round: 115 / acc: 12.920% / loss: 2.2834 / Time: 0.99s
======================================================================================================

round 115 local learning rate = 0.001
round 116 local learning rate = 0.001
round 117 local learning rate = 0.001
round 118 local learning rate = 0.001
round 119 local learning rate = 0.001

>>> Round:  120 / Acc: 12.965% / Loss: 2.2814 / Grad Norm: 0.1640 / Grad Diff: 0.9952 / Time: 7.38s
======================================================================================================

= Test = round: 120 / acc: 12.820% / loss: 2.2820 / Time: 0.72s
======================================================================================================

round 120 local learning rate = 0.001
round 121 local learning rate = 0.001
round 122 local learning rate = 0.001
round 123 local learning rate = 0.001
round 124 local learning rate = 0.001

>>> Round:  125 / Acc: 12.950% / Loss: 2.2800 / Grad Norm: 0.1684 / Grad Diff: 1.0249 / Time: 7.34s
======================================================================================================

= Test = round: 125 / acc: 12.750% / loss: 2.2805 / Time: 0.74s
======================================================================================================

round 125 local learning rate = 0.001
round 126 local learning rate = 0.001
round 127 local learning rate = 0.001
round 128 local learning rate = 0.001
round 129 local learning rate = 0.001

>>> Round:  130 / Acc: 13.037% / Loss: 2.2785 / Grad Norm: 0.1730 / Grad Diff: 1.0573 / Time: 8.45s
======================================================================================================

= Test = round: 130 / acc: 12.780% / loss: 2.2790 / Time: 0.72s
======================================================================================================

round 130 local learning rate = 0.001
round 131 local learning rate = 0.001
round 132 local learning rate = 0.001
round 133 local learning rate = 0.001
round 134 local learning rate = 0.001

>>> Round:  135 / Acc: 13.133% / Loss: 2.2769 / Grad Norm: 0.1781 / Grad Diff: 1.0928 / Time: 7.44s
======================================================================================================

= Test = round: 135 / acc: 12.740% / loss: 2.2774 / Time: 0.73s
======================================================================================================

round 135 local learning rate = 0.001
round 136 local learning rate = 0.001
round 137 local learning rate = 0.001
round 138 local learning rate = 0.001
round 139 local learning rate = 0.001

>>> Round:  140 / Acc: 13.312% / Loss: 2.2752 / Grad Norm: 0.1835 / Grad Diff: 1.1322 / Time: 7.39s
======================================================================================================

= Test = round: 140 / acc: 12.890% / loss: 2.2757 / Time: 0.74s
======================================================================================================

round 140 local learning rate = 0.001
round 141 local learning rate = 0.001
round 142 local learning rate = 0.001
round 143 local learning rate = 0.001
round 144 local learning rate = 0.001

>>> Round:  145 / Acc: 13.506% / Loss: 2.2733 / Grad Norm: 0.1893 / Grad Diff: 1.1760 / Time: 7.45s
======================================================================================================

= Test = round: 145 / acc: 13.000% / loss: 2.2739 / Time: 0.75s
======================================================================================================

round 145 local learning rate = 0.001
round 146 local learning rate = 0.001
round 147 local learning rate = 0.001
round 148 local learning rate = 0.001
round 149 local learning rate = 0.001

>>> Round:  150 / Acc: 13.875% / Loss: 2.2714 / Grad Norm: 0.1955 / Grad Diff: 1.2241 / Time: 7.60s
======================================================================================================

= Test = round: 150 / acc: 13.230% / loss: 2.2719 / Time: 0.76s
======================================================================================================

round 150 local learning rate = 0.001
round 151 local learning rate = 0.001
round 152 local learning rate = 0.001
round 153 local learning rate = 0.001
round 154 local learning rate = 0.001

>>> Round:  155 / Acc: 14.292% / Loss: 2.2693 / Grad Norm: 0.2022 / Grad Diff: 1.2775 / Time: 7.42s
======================================================================================================

= Test = round: 155 / acc: 13.690% / loss: 2.2698 / Time: 0.73s
======================================================================================================

round 155 local learning rate = 0.001
round 156 local learning rate = 0.001
round 157 local learning rate = 0.001
round 158 local learning rate = 0.001
round 159 local learning rate = 0.001

>>> Round:  160 / Acc: 14.799% / Loss: 2.2671 / Grad Norm: 0.2095 / Grad Diff: 1.3371 / Time: 7.39s
======================================================================================================

= Test = round: 160 / acc: 14.010% / loss: 2.2676 / Time: 0.75s
======================================================================================================

round 160 local learning rate = 0.001
round 161 local learning rate = 0.001
round 162 local learning rate = 0.001
round 163 local learning rate = 0.001
round 164 local learning rate = 0.001

>>> Round:  165 / Acc: 15.423% / Loss: 2.2647 / Grad Norm: 0.2173 / Grad Diff: 1.4038 / Time: 10.21s
======================================================================================================

= Test = round: 165 / acc: 14.500% / loss: 2.2652 / Time: 1.04s
======================================================================================================

round 165 local learning rate = 0.001
round 166 local learning rate = 0.001
round 167 local learning rate = 0.001
round 168 local learning rate = 0.001
round 169 local learning rate = 0.001

>>> Round:  170 / Acc: 16.157% / Loss: 2.2621 / Grad Norm: 0.2256 / Grad Diff: 1.4784 / Time: 7.77s
======================================================================================================

= Test = round: 170 / acc: 15.080% / loss: 2.2626 / Time: 0.69s
======================================================================================================

round 170 local learning rate = 0.001
round 171 local learning rate = 0.001
round 172 local learning rate = 0.001
round 173 local learning rate = 0.001
round 174 local learning rate = 0.001

>>> Round:  175 / Acc: 16.934% / Loss: 2.2593 / Grad Norm: 0.2347 / Grad Diff: 1.5622 / Time: 7.47s
======================================================================================================

= Test = round: 175 / acc: 15.870% / loss: 2.2597 / Time: 0.73s
======================================================================================================

round 175 local learning rate = 0.001
round 176 local learning rate = 0.001
round 177 local learning rate = 0.001
round 178 local learning rate = 0.001
round 179 local learning rate = 0.001

>>> Round:  180 / Acc: 17.782% / Loss: 2.2563 / Grad Norm: 0.2444 / Grad Diff: 1.6570 / Time: 7.36s
======================================================================================================

= Test = round: 180 / acc: 16.590% / loss: 2.2567 / Time: 0.75s
======================================================================================================

round 180 local learning rate = 0.001
round 181 local learning rate = 0.001
round 182 local learning rate = 0.001
round 183 local learning rate = 0.001
round 184 local learning rate = 0.001

>>> Round:  185 / Acc: 18.664% / Loss: 2.2529 / Grad Norm: 0.2548 / Grad Diff: 1.7647 / Time: 7.79s
======================================================================================================

= Test = round: 185 / acc: 17.380% / loss: 2.2533 / Time: 0.75s
======================================================================================================

round 185 local learning rate = 0.001
round 186 local learning rate = 0.001
round 187 local learning rate = 0.001
round 188 local learning rate = 0.001
round 189 local learning rate = 0.001

>>> Round:  190 / Acc: 19.559% / Loss: 2.2493 / Grad Norm: 0.2659 / Grad Diff: 1.8870 / Time: 7.43s
======================================================================================================

= Test = round: 190 / acc: 18.170% / loss: 2.2496 / Time: 0.80s
======================================================================================================

round 190 local learning rate = 0.001
round 191 local learning rate = 0.001
round 192 local learning rate = 0.001
round 193 local learning rate = 0.001
round 194 local learning rate = 0.001

>>> Round:  195 / Acc: 20.380% / Loss: 2.2454 / Grad Norm: 0.2779 / Grad Diff: 2.0270 / Time: 7.32s
======================================================================================================

= Test = round: 195 / acc: 19.190% / loss: 2.2456 / Time: 0.73s
======================================================================================================

round 195 local learning rate = 0.001
round 196 local learning rate = 0.001
round 197 local learning rate = 0.001
round 198 local learning rate = 0.001
round 199 local learning rate = 0.001

>>> Round:  200 / Acc: 21.299% / Loss: 2.2410 / Grad Norm: 0.2907 / Grad Diff: 2.1875 / Time: 9.65s
======================================================================================================

= Test = round: 200 / acc: 20.160% / loss: 2.2413 / Time: 0.77s
======================================================================================================

>>> Training model_ft
Epoch: 001, Train_loss: 2.1144, Train_acc: 0.2724, Test_loss: 2.1152, Test_acc: 0.2725
Epoch: 006, Train_loss: 2.0215, Train_acc: 0.3162, Test_loss: 2.0226, Test_acc: 0.3134
Epoch: 011, Train_loss: 2.0062, Train_acc: 0.3420, Test_loss: 2.0069, Test_acc: 0.3371
Epoch: 016, Train_loss: 1.9960, Train_acc: 0.3537, Test_loss: 1.9957, Test_acc: 0.3511
Epoch: 021, Train_loss: 1.9931, Train_acc: 0.3597, Test_loss: 1.9924, Test_acc: 0.3568
Epoch: 026, Train_loss: 1.9863, Train_acc: 0.3602, Test_loss: 1.9857, Test_acc: 0.3576
Epoch: 031, Train_loss: 1.9866, Train_acc: 0.3590, Test_loss: 1.9854, Test_acc: 0.3597
Epoch: 036, Train_loss: 1.9863, Train_acc: 0.3644, Test_loss: 1.9849, Test_acc: 0.3624
Epoch: 041, Train_loss: 1.9885, Train_acc: 0.3556, Test_loss: 1.9860, Test_acc: 0.3524
Fine-tuning early stopped. Model saved at ./models/ft_checkpoints/20230921212212_model_ft.pt.
Model saved at ./models/ft_checkpoints/20230921212212_model_ft.pt.
>>> Fine-tuning done!
>>> Evaluating model_source_only
model_ft: [1.9837418288890067, 0.35182454534668905, 1.9827009135121147, 0.3478502388623486]
model_source_only: [2.2923212460535196, 0.12915035338384095, 2.2924245799227485, 0.1299855571603155]
fl_test_acc_mean 0.1997
model_source_only_test_acc_mean 0.1299855571603155
model_ft_test_acc_mean 0.3478502388623486
