nohup: ignoring input
working!
Using device: cuda:0
>>> Arguments:
	             algo : fedavgtl
	            alpha : 13.2316427
	       batch_size : 64
	clients_per_round : 100
	          dataset : mnist_all_data_1_equal_niid
	           device : cuda:0
	              dis : 
	   early_stopping : 10
	       eval_every : 5
	    ft_batch_size : 128
	       ft_dataset : mnist-m
	        ft_epochs : 200
	            ft_lr : 0.001
	            ft_wd : 0.01
	              gpu : True
	      input_shape : (1, 28, 28)
	           last_k : 1
	               lr : 0.01
	            model : lenet
	           n_init : 1
	        noaverage : False
	             noft : False
	          noprint : False
	        num_class : 10
	        num_epoch : 1
	        num_round : 200
	           opt_lr : False
	            reg_J : False
	       reg_J_coef : 0.0
	   reg_J_ind_coef : 0.0
	  reg_J_norm_coef : 0.001
	           repeat : 1
	     repeat_epoch : 10
	             seed : 0
	               wd : 0.0
>>> Read data from:
     ./data/mnist/data/all_data_1.pkl
>>> The estimate of constant alpha is 13.2316427.
>>> Read data from:
     ./data/mnist/data/train/all_data_1_equal_niid.pkl
     ./data/mnist/data/test/all_data_1_equal_niid.pkl

************************************************************************************************************************

uid: 20230921201518
FL pretrained model will be saved at ./models/lenet_mnist_20230921201518.pt
>>> Use gpu on device cuda:0
>>> Model statistic per layer
LeNet_MNIST(
  286.12 KMac, 100.000% MACs, 
  (conv1): Conv2d(89.856 KMac, 31.405% MACs, 1, 6, kernel_size=(5, 5), stride=(1, 1))
  (conv2): Conv2d(154.624 KMac, 54.042% MACs, 6, 16, kernel_size=(5, 5), stride=(1, 1))
  (fc1): Linear(30.72 KMac, 10.737% MACs, in_features=256, out_features=120, bias=True)
  (fc2): Linear(10.08 KMac, 3.523% MACs, in_features=120, out_features=84, bias=True)
  (fc3): Linear(840.0 Mac, 0.294% MACs, in_features=84, out_features=10, bias=True)
)
>>> Activate a worker for training
>>> Initialize 100 clients in total
>>> Weigh updates by simple average
>>> Select 100 clients per round 


>>> Round:    0 / Acc: 11.452% / Loss: 2.3094 / Grad Norm: 0.2310 / Grad Diff: 1.8782 / Time: 10.24s
======================================================================================================

= Test = round: 0 / acc: 10.370% / loss: 2.3121 / Time: 0.86s
======================================================================================================

round 0 local learning rate = 0.01
round 1 local learning rate = 0.01
round 2 local learning rate = 0.01
round 3 local learning rate = 0.01
round 4 local learning rate = 0.01

>>> Round:    5 / Acc: 21.978% / Loss: 2.2715 / Grad Norm: 0.8017 / Grad Diff: 34.6212 / Time: 10.65s
======================================================================================================

= Test = round: 5 / acc: 22.940% / loss: 2.2713 / Time: 0.92s
======================================================================================================

round 5 local learning rate = 0.01
round 6 local learning rate = 0.01
round 7 local learning rate = 0.01
round 8 local learning rate = 0.01
round 9 local learning rate = 0.01

>>> Round:   10 / Acc: 54.494% / Loss: 2.0754 / Grad Norm: 1.1208 / Grad Diff: 150.0067 / Time: 10.41s
======================================================================================================

= Test = round: 10 / acc: 56.370% / loss: 2.0702 / Time: 0.93s
======================================================================================================

round 10 local learning rate = 0.01
round 11 local learning rate = 0.01
round 12 local learning rate = 0.01
round 13 local learning rate = 0.01
round 14 local learning rate = 0.01

>>> Round:   15 / Acc: 65.771% / Loss: 1.8218 / Grad Norm: 1.3084 / Grad Diff: 145.6448 / Time: 10.48s
======================================================================================================

= Test = round: 15 / acc: 67.940% / loss: 1.8077 / Time: 0.92s
======================================================================================================

round 15 local learning rate = 0.01
round 16 local learning rate = 0.01
round 17 local learning rate = 0.01
round 18 local learning rate = 0.01
round 19 local learning rate = 0.01

>>> Round:   20 / Acc: 70.480% / Loss: 1.4890 / Grad Norm: 1.4198 / Grad Diff: 144.2255 / Time: 11.42s
======================================================================================================

= Test = round: 20 / acc: 72.590% / loss: 1.4604 / Time: 1.19s
======================================================================================================

round 20 local learning rate = 0.01
round 21 local learning rate = 0.01
round 22 local learning rate = 0.01
round 23 local learning rate = 0.01
round 24 local learning rate = 0.01

>>> Round:   25 / Acc: 73.375% / Loss: 1.1969 / Grad Norm: 1.3605 / Grad Diff: 136.8075 / Time: 10.87s
======================================================================================================

= Test = round: 25 / acc: 75.500% / loss: 1.1572 / Time: 0.86s
======================================================================================================

round 25 local learning rate = 0.01
round 26 local learning rate = 0.01
round 27 local learning rate = 0.01
round 28 local learning rate = 0.01
round 29 local learning rate = 0.01

>>> Round:   30 / Acc: 75.797% / Loss: 0.9978 / Grad Norm: 1.2635 / Grad Diff: 122.0608 / Time: 10.37s
======================================================================================================

= Test = round: 30 / acc: 77.960% / loss: 0.9528 / Time: 0.90s
======================================================================================================

round 30 local learning rate = 0.01
round 31 local learning rate = 0.01
round 32 local learning rate = 0.01
round 33 local learning rate = 0.01
round 34 local learning rate = 0.01

>>> Round:   35 / Acc: 77.596% / Loss: 0.8716 / Grad Norm: 1.1401 / Grad Diff: 102.8037 / Time: 10.24s
======================================================================================================

= Test = round: 35 / acc: 79.500% / loss: 0.8267 / Time: 0.90s
======================================================================================================

round 35 local learning rate = 0.01
round 36 local learning rate = 0.01
round 37 local learning rate = 0.01
round 38 local learning rate = 0.01
round 39 local learning rate = 0.01

>>> Round:   40 / Acc: 79.179% / Loss: 0.7747 / Grad Norm: 1.0346 / Grad Diff: 93.3113 / Time: 10.02s
======================================================================================================

= Test = round: 40 / acc: 80.640% / loss: 0.7325 / Time: 0.89s
======================================================================================================

round 40 local learning rate = 0.01
round 41 local learning rate = 0.01
round 42 local learning rate = 0.01
round 43 local learning rate = 0.01
round 44 local learning rate = 0.01

>>> Round:   45 / Acc: 80.148% / Loss: 0.7089 / Grad Norm: 1.0128 / Grad Diff: 84.4311 / Time: 10.44s
======================================================================================================

= Test = round: 45 / acc: 81.370% / loss: 0.6673 / Time: 0.92s
======================================================================================================

round 45 local learning rate = 0.01
round 46 local learning rate = 0.01
round 47 local learning rate = 0.01
round 48 local learning rate = 0.01
round 49 local learning rate = 0.01

>>> Round:   50 / Acc: 81.332% / Loss: 0.6562 / Grad Norm: 0.8653 / Grad Diff: 78.8771 / Time: 10.27s
======================================================================================================

= Test = round: 50 / acc: 82.310% / loss: 0.6179 / Time: 0.86s
======================================================================================================

round 50 local learning rate = 0.01
round 51 local learning rate = 0.01
round 52 local learning rate = 0.01
round 53 local learning rate = 0.01
round 54 local learning rate = 0.01

>>> Round:   55 / Acc: 82.055% / Loss: 0.6158 / Grad Norm: 0.8609 / Grad Diff: 74.1469 / Time: 9.99s
======================================================================================================

= Test = round: 55 / acc: 83.220% / loss: 0.5792 / Time: 0.86s
======================================================================================================

round 55 local learning rate = 0.01
round 56 local learning rate = 0.01
round 57 local learning rate = 0.01
round 58 local learning rate = 0.01
round 59 local learning rate = 0.01

>>> Round:   60 / Acc: 82.945% / Loss: 0.5821 / Grad Norm: 0.7164 / Grad Diff: 69.5635 / Time: 10.53s
======================================================================================================

= Test = round: 60 / acc: 84.010% / loss: 0.5458 / Time: 0.86s
======================================================================================================

round 60 local learning rate = 0.01
round 61 local learning rate = 0.01
round 62 local learning rate = 0.01
round 63 local learning rate = 0.01
round 64 local learning rate = 0.01

>>> Round:   65 / Acc: 83.718% / Loss: 0.5544 / Grad Norm: 0.6460 / Grad Diff: 66.3576 / Time: 10.30s
======================================================================================================

= Test = round: 65 / acc: 84.700% / loss: 0.5191 / Time: 0.86s
======================================================================================================

round 65 local learning rate = 0.01
round 66 local learning rate = 0.01
round 67 local learning rate = 0.01
round 68 local learning rate = 0.01
round 69 local learning rate = 0.01

>>> Round:   70 / Acc: 84.214% / Loss: 0.5316 / Grad Norm: 0.6261 / Grad Diff: 63.0761 / Time: 10.57s
======================================================================================================

= Test = round: 70 / acc: 85.350% / loss: 0.4968 / Time: 0.91s
======================================================================================================

round 70 local learning rate = 0.01
round 71 local learning rate = 0.01
round 72 local learning rate = 0.01
round 73 local learning rate = 0.01
round 74 local learning rate = 0.01

>>> Round:   75 / Acc: 84.828% / Loss: 0.5107 / Grad Norm: 0.6190 / Grad Diff: 61.1619 / Time: 10.78s
======================================================================================================

= Test = round: 75 / acc: 86.050% / loss: 0.4771 / Time: 0.97s
======================================================================================================

round 75 local learning rate = 0.01
round 76 local learning rate = 0.01
round 77 local learning rate = 0.01
round 78 local learning rate = 0.01
round 79 local learning rate = 0.01

>>> Round:   80 / Acc: 85.310% / Loss: 0.4941 / Grad Norm: 0.6086 / Grad Diff: 57.9659 / Time: 10.64s
======================================================================================================

= Test = round: 80 / acc: 86.590% / loss: 0.4602 / Time: 0.96s
======================================================================================================

round 80 local learning rate = 0.01
round 81 local learning rate = 0.01
round 82 local learning rate = 0.01
round 83 local learning rate = 0.01
round 84 local learning rate = 0.01

>>> Round:   85 / Acc: 85.865% / Loss: 0.4767 / Grad Norm: 0.5192 / Grad Diff: 55.7106 / Time: 12.36s
======================================================================================================

= Test = round: 85 / acc: 87.040% / loss: 0.4439 / Time: 0.87s
======================================================================================================

round 85 local learning rate = 0.01
round 86 local learning rate = 0.01
round 87 local learning rate = 0.01
round 88 local learning rate = 0.01
round 89 local learning rate = 0.01

>>> Round:   90 / Acc: 86.221% / Loss: 0.4641 / Grad Norm: 0.5640 / Grad Diff: 52.7756 / Time: 10.27s
======================================================================================================

= Test = round: 90 / acc: 87.560% / loss: 0.4309 / Time: 0.89s
======================================================================================================

round 90 local learning rate = 0.01
round 91 local learning rate = 0.01
round 92 local learning rate = 0.01
round 93 local learning rate = 0.01
round 94 local learning rate = 0.01

>>> Round:   95 / Acc: 86.653% / Loss: 0.4500 / Grad Norm: 0.5353 / Grad Diff: 50.9532 / Time: 10.67s
======================================================================================================

= Test = round: 95 / acc: 87.900% / loss: 0.4173 / Time: 0.91s
======================================================================================================

round 95 local learning rate = 0.01
round 96 local learning rate = 0.01
round 97 local learning rate = 0.01
round 98 local learning rate = 0.01
round 99 local learning rate = 0.01

>>> Round:  100 / Acc: 87.057% / Loss: 0.4386 / Grad Norm: 0.5450 / Grad Diff: 48.6043 / Time: 12.54s
======================================================================================================

= Test = round: 100 / acc: 88.210% / loss: 0.4067 / Time: 1.22s
======================================================================================================

round 100 local learning rate = 0.01
round 101 local learning rate = 0.01
round 102 local learning rate = 0.01
round 103 local learning rate = 0.01
round 104 local learning rate = 0.01

>>> Round:  105 / Acc: 87.395% / Loss: 0.4251 / Grad Norm: 0.5461 / Grad Diff: 47.8771 / Time: 10.36s
======================================================================================================

= Test = round: 105 / acc: 88.520% / loss: 0.3929 / Time: 0.86s
======================================================================================================

round 105 local learning rate = 0.01
round 106 local learning rate = 0.01
round 107 local learning rate = 0.01
round 108 local learning rate = 0.01
round 109 local learning rate = 0.01

>>> Round:  110 / Acc: 87.692% / Loss: 0.4141 / Grad Norm: 0.4703 / Grad Diff: 45.4586 / Time: 10.56s
======================================================================================================

= Test = round: 110 / acc: 88.890% / loss: 0.3828 / Time: 0.90s
======================================================================================================

round 110 local learning rate = 0.01
round 111 local learning rate = 0.01
round 112 local learning rate = 0.01
round 113 local learning rate = 0.01
round 114 local learning rate = 0.01

>>> Round:  115 / Acc: 87.985% / Loss: 0.4049 / Grad Norm: 0.4672 / Grad Diff: 43.2660 / Time: 11.08s
======================================================================================================

= Test = round: 115 / acc: 89.050% / loss: 0.3746 / Time: 1.25s
======================================================================================================

round 115 local learning rate = 0.01
round 116 local learning rate = 0.01
round 117 local learning rate = 0.01
round 118 local learning rate = 0.01
round 119 local learning rate = 0.01

>>> Round:  120 / Acc: 88.221% / Loss: 0.3946 / Grad Norm: 0.5494 / Grad Diff: 42.9969 / Time: 10.99s
======================================================================================================

= Test = round: 120 / acc: 89.260% / loss: 0.3640 / Time: 0.93s
======================================================================================================

round 120 local learning rate = 0.01
round 121 local learning rate = 0.01
round 122 local learning rate = 0.01
round 123 local learning rate = 0.01
round 124 local learning rate = 0.01

>>> Round:  125 / Acc: 88.489% / Loss: 0.3853 / Grad Norm: 0.4567 / Grad Diff: 41.2152 / Time: 10.44s
======================================================================================================

= Test = round: 125 / acc: 89.430% / loss: 0.3548 / Time: 0.96s
======================================================================================================

round 125 local learning rate = 0.01
round 126 local learning rate = 0.01
round 127 local learning rate = 0.01
round 128 local learning rate = 0.01
round 129 local learning rate = 0.01

>>> Round:  130 / Acc: 88.823% / Loss: 0.3763 / Grad Norm: 0.4211 / Grad Diff: 39.8488 / Time: 12.17s
======================================================================================================

= Test = round: 130 / acc: 89.600% / loss: 0.3465 / Time: 1.03s
======================================================================================================

round 130 local learning rate = 0.01
round 131 local learning rate = 0.01
round 132 local learning rate = 0.01
round 133 local learning rate = 0.01
round 134 local learning rate = 0.01

>>> Round:  135 / Acc: 89.094% / Loss: 0.3681 / Grad Norm: 0.3873 / Grad Diff: 38.4881 / Time: 11.81s
======================================================================================================

= Test = round: 135 / acc: 89.940% / loss: 0.3394 / Time: 0.99s
======================================================================================================

round 135 local learning rate = 0.01
round 136 local learning rate = 0.01
round 137 local learning rate = 0.01
round 138 local learning rate = 0.01
round 139 local learning rate = 0.01

>>> Round:  140 / Acc: 89.295% / Loss: 0.3611 / Grad Norm: 0.4202 / Grad Diff: 37.0755 / Time: 12.20s
======================================================================================================

= Test = round: 140 / acc: 90.140% / loss: 0.3320 / Time: 1.02s
======================================================================================================

round 140 local learning rate = 0.01
round 141 local learning rate = 0.01
round 142 local learning rate = 0.01
round 143 local learning rate = 0.01
round 144 local learning rate = 0.01

>>> Round:  145 / Acc: 89.546% / Loss: 0.3534 / Grad Norm: 0.4123 / Grad Diff: 35.9629 / Time: 12.35s
======================================================================================================

= Test = round: 145 / acc: 90.350% / loss: 0.3253 / Time: 1.21s
======================================================================================================

round 145 local learning rate = 0.01
round 146 local learning rate = 0.01
round 147 local learning rate = 0.01
round 148 local learning rate = 0.01
round 149 local learning rate = 0.01

>>> Round:  150 / Acc: 89.725% / Loss: 0.3461 / Grad Norm: 0.4070 / Grad Diff: 35.0402 / Time: 12.57s
======================================================================================================

= Test = round: 150 / acc: 90.620% / loss: 0.3175 / Time: 1.10s
======================================================================================================

round 150 local learning rate = 0.01
round 151 local learning rate = 0.01
round 152 local learning rate = 0.01
round 153 local learning rate = 0.01
round 154 local learning rate = 0.01

>>> Round:  155 / Acc: 89.899% / Loss: 0.3394 / Grad Norm: 0.4282 / Grad Diff: 34.0455 / Time: 12.08s
======================================================================================================

= Test = round: 155 / acc: 90.770% / loss: 0.3114 / Time: 1.12s
======================================================================================================

round 155 local learning rate = 0.01
round 156 local learning rate = 0.01
round 157 local learning rate = 0.01
round 158 local learning rate = 0.01
round 159 local learning rate = 0.01

>>> Round:  160 / Acc: 90.137% / Loss: 0.3332 / Grad Norm: 0.4064 / Grad Diff: 32.6708 / Time: 11.71s
======================================================================================================

= Test = round: 160 / acc: 90.990% / loss: 0.3058 / Time: 1.10s
======================================================================================================

round 160 local learning rate = 0.01
round 161 local learning rate = 0.01
round 162 local learning rate = 0.01
round 163 local learning rate = 0.01
round 164 local learning rate = 0.01

>>> Round:  165 / Acc: 90.277% / Loss: 0.3256 / Grad Norm: 0.3677 / Grad Diff: 32.1945 / Time: 12.15s
======================================================================================================

= Test = round: 165 / acc: 91.130% / loss: 0.2987 / Time: 1.29s
======================================================================================================

round 165 local learning rate = 0.01
round 166 local learning rate = 0.01
round 167 local learning rate = 0.01
round 168 local learning rate = 0.01
round 169 local learning rate = 0.01

>>> Round:  170 / Acc: 90.507% / Loss: 0.3199 / Grad Norm: 0.3219 / Grad Diff: 30.8212 / Time: 11.74s
======================================================================================================

= Test = round: 170 / acc: 91.340% / loss: 0.2936 / Time: 1.02s
======================================================================================================

round 170 local learning rate = 0.01
round 171 local learning rate = 0.01
round 172 local learning rate = 0.01
round 173 local learning rate = 0.01
round 174 local learning rate = 0.01

>>> Round:  175 / Acc: 90.598% / Loss: 0.3140 / Grad Norm: 0.3691 / Grad Diff: 30.1403 / Time: 14.01s
======================================================================================================

= Test = round: 175 / acc: 91.460% / loss: 0.2880 / Time: 1.03s
======================================================================================================

round 175 local learning rate = 0.01
round 176 local learning rate = 0.01
round 177 local learning rate = 0.01
round 178 local learning rate = 0.01
round 179 local learning rate = 0.01

>>> Round:  180 / Acc: 90.790% / Loss: 0.3066 / Grad Norm: 0.3290 / Grad Diff: 30.3638 / Time: 11.95s
======================================================================================================

= Test = round: 180 / acc: 91.650% / loss: 0.2805 / Time: 1.05s
======================================================================================================

round 180 local learning rate = 0.01
round 181 local learning rate = 0.01
round 182 local learning rate = 0.01
round 183 local learning rate = 0.01
round 184 local learning rate = 0.01

>>> Round:  185 / Acc: 90.893% / Loss: 0.3025 / Grad Norm: 0.3449 / Grad Diff: 28.7556 / Time: 12.32s
======================================================================================================

= Test = round: 185 / acc: 91.820% / loss: 0.2773 / Time: 1.05s
======================================================================================================

round 185 local learning rate = 0.01
round 186 local learning rate = 0.01
round 187 local learning rate = 0.01
round 188 local learning rate = 0.01
round 189 local learning rate = 0.01

>>> Round:  190 / Acc: 91.028% / Loss: 0.2962 / Grad Norm: 0.3263 / Grad Diff: 28.7543 / Time: 12.38s
======================================================================================================

= Test = round: 190 / acc: 91.950% / loss: 0.2710 / Time: 1.02s
======================================================================================================

round 190 local learning rate = 0.01
round 191 local learning rate = 0.01
round 192 local learning rate = 0.01
round 193 local learning rate = 0.01
round 194 local learning rate = 0.01

>>> Round:  195 / Acc: 91.199% / Loss: 0.2911 / Grad Norm: 0.3059 / Grad Diff: 27.9754 / Time: 14.88s
======================================================================================================

= Test = round: 195 / acc: 92.130% / loss: 0.2665 / Time: 1.37s
======================================================================================================

round 195 local learning rate = 0.01
round 196 local learning rate = 0.01
round 197 local learning rate = 0.01
round 198 local learning rate = 0.01
round 199 local learning rate = 0.01

>>> Round:  200 / Acc: 91.323% / Loss: 0.2861 / Grad Norm: 0.2788 / Grad Diff: 27.4174 / Time: 12.54s
======================================================================================================

= Test = round: 200 / acc: 92.160% / loss: 0.2616 / Time: 1.07s
======================================================================================================

>>> Training model_ft
Epoch: 001, Train_loss: 1.2584, Train_acc: 0.6138, Test_loss: 1.2366, Test_acc: 0.6224
Epoch: 006, Train_loss: 1.0845, Train_acc: 0.6668, Test_loss: 1.0686, Test_acc: 0.6733
Epoch: 011, Train_loss: 1.0587, Train_acc: 0.6810, Test_loss: 1.0467, Test_acc: 0.6837
Epoch: 016, Train_loss: 1.0570, Train_acc: 0.6813, Test_loss: 1.0439, Test_acc: 0.6855
Epoch: 021, Train_loss: 1.0483, Train_acc: 0.6823, Test_loss: 1.0382, Test_acc: 0.6878
Epoch: 026, Train_loss: 1.0552, Train_acc: 0.6793, Test_loss: 1.0415, Test_acc: 0.6829
Epoch: 031, Train_loss: 1.0512, Train_acc: 0.6826, Test_loss: 1.0392, Test_acc: 0.6868
Epoch: 036, Train_loss: 1.0458, Train_acc: 0.6877, Test_loss: 1.0359, Test_acc: 0.6909
Epoch: 041, Train_loss: 1.0489, Train_acc: 0.6836, Test_loss: 1.0380, Test_acc: 0.6844
Epoch: 046, Train_loss: 1.0499, Train_acc: 0.6798, Test_loss: 1.0382, Test_acc: 0.6838
Epoch: 051, Train_loss: 1.0417, Train_acc: 0.6880, Test_loss: 1.0301, Test_acc: 0.6905
Epoch: 056, Train_loss: 1.0445, Train_acc: 0.6871, Test_loss: 1.0341, Test_acc: 0.6889
Epoch: 061, Train_loss: 1.0435, Train_acc: 0.6842, Test_loss: 1.0352, Test_acc: 0.6873
Epoch: 066, Train_loss: 1.0411, Train_acc: 0.6834, Test_loss: 1.0300, Test_acc: 0.6880
Fine-tuning early stopped. Model saved at ./models/ft_checkpoints/20230921201518_model_ft.pt.
Model saved at ./models/ft_checkpoints/20230921201518_model_ft.pt.
>>> Fine-tuning done!
>>> Evaluating model_source_only
model_ft: [1.0404551135138156, 0.6872764868392062, 1.0308246473486775, 0.6910343295189424]
model_source_only: [2.3566515334341354, 0.42173861459975254, 2.3909886615592337, 0.42161982001999776]
fl_test_acc_mean 0.9215
model_source_only_test_acc_mean 0.42161982001999776
model_ft_test_acc_mean 0.6910343295189424
